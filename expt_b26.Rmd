---
title: "Expt_b26"
author: "Max Schubert"
date: "6/19/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stringr)
library(plyr)
require(ggplot2)
require(data.table)
require(scales)
library(gridExtra)
library(plotly)

parent_folder <- here::here('expt_b26')
```

```{r get data}
mergebinpath <- paste(parent_folder,"merged_TC_march2019", sep = "/" )
merged_bins.dt <- data.table(fread(mergebinpath))
mergemelt.dt <- melt(merged_bins.dt, id.var=c('read_id', 'total_count', 'bc_read'), value.name='Count', variable.name='Sample')
mergemelt.dt[, SampleNum := str_replace_all(Sample, "_cutcount", "")]
mergemelt.dt = mergemelt.dt[Count > 0 ] #discard zeroes

#metadata
liblistpath <- paste(parent_folder,"b26_TC_metadata.csv", sep = "/" )
liblistdt <- data.table(fread(liblistpath))


```
#### get donors, merge to create annotated table
```{r allele_list_merge}
allelelistpath <- paste(parent_folder,"allele_annotated_list.csv", sep = "/" )
seq_annot_dt <- data.table(fread(allelelistpath))
seq_annot_dt[, bc_read := prodonor_seq]

#merge sample and seq metadata to big table
annotated_megatable <- liblistdt[mergemelt.dt, on = "SampleNum", nomatch = 0]
seq_annotated_megatable <- annotated_megatable[seq_annot_dt, on = "bc_read", nomatch = 0]

#filterstats
count_before_join = sum(annotated_megatable$Count)
count_after_join = sum(seq_annotated_megatable$Count)
filterstat = paste(as.character(count_before_join),
                   "reads in,",
                   as.character(count_after_join),
                   "reads out, or",
                   count_after_join/count_before_join*100,
                   "%", sep = " ")
print(filterstat)
```

## normalize counts to neutral allele pool, for each sample
### alternatively, calculate frequency of each seq (sec count / total count)
```{r normalize}
megatable_ratios <- seq_annotated_megatable[, mean_neutrals := mean(Count[mut_class == "Neutral"]), by='SampleNum']
megatable_ratios <- megatable_ratios[, ratio_to_neutralmean := Count/mean_neutrals] #no longer by = 'bc_read'
#same thing, but with median neutral value
megatable_ratios <- seq_annotated_megatable[, median_neutrals := as.double(median(Count[mut_class == "Neutral"])), by='SampleNum']
megatable_ratios <- megatable_ratios[, ratio_to_neutralmedian := Count/median_neutrals] #no longer by = 'bc_read'


megatable_ratios <- megatable_ratios[, total_count_sample := sum(Count), by='SampleNum']
megatable_ratios <- megatable_ratios[, seq_freq := Count/total_count_sample]

```

```{r filter_initial_no_rif}
#first two timepoints, no rif is included
early = megatable_ratios[time_point %in% c(0, 1)]
late_no_rif = megatable_ratios[expt_set == "tc"][rif == 0][time_point %in% c(2, 3, 4, 5)]
no_rif_tc <- rbind(early, late_no_rif)

#initialize to t0
no_rif_tc[,
           t0.rel.enrichment := ratio_to_neutralmedian/ ratio_to_neutralmedian[time_point==0],
           by=c("tx","nickname")] #within each replicate, for each sequence

#while we're at it, clean up the table
no_rif_tc[, c("read_id",
               "total_count",
               "bc_read",
               "options",
               "mutation",
               "barcodes",
               "drug_resistance_expected",
               "drug_sensitivity_expected"):=NULL]
```

## summarize the data, including no init version
```{r stat_summ2}
#specify current var to summarize
current_var = quote(seq_freq) ####

noriftcsumm <- no_rif_tc[,
                        list(
                          Count = Count,
                          N= .N,
                          mean_var = mean(eval(current_var)),
                          sd_var= sd(eval(current_var)),
                          se_var= sd(eval(current_var)) / sqrt(.N) ),
                        by=c("nickname", "mut_class", "time_point", "ssap")]

```

# first, looking at beta
```{r plot_norif_beta}

current = noriftcsumm[ssap == "beta"] #[mut_class %in% c("Lethal", "Neutral")]

ggplot(current, aes(x=time_point, y=mean_var, color=nickname)) + 
  geom_errorbar(aes(ymin=mean_var-se_var, ymax=mean_var+se_var, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans() ) +#, #limit=c(0.0005, 8), 
                     #breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  facet_wrap(~mut_class) +
  theme(legend.position="none")

```
some lethal and deleterious seeming to drop out: gyrA and rpsL




#########OTHER CRUFT PASTED BELOW


# then, looking at PF020
```{r plot_norif_PF020}

current = noriftcsumm[ssap == "PF020"] #[mut_class %in% c("Lethal", "Neutral")]

ggplot(current, aes(x=time_point, y=mean_var, color=nickname)) + 
  geom_line(aes(alpha = .3)) +
  geom_errorbar(aes(ymin=mean_var-se_var, ymax=mean_var+se_var, alpha = .3), width=.1, color = "black") +
  geom_point(aes(group = nickname, alpha = .3, shape = as.factor(N))) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  facet_wrap(~mut_class) +
  theme(legend.position="none")

```



what if we ditch the last two timepoints AND don't initialize, without rif
```{r plot_no_rif_beta_short}
#i'm also going to simplify to just three classes
# first, looking at beta
current = noriftcsumm[ssap == "beta"][time_point %in% c(0, 1, 2, 3)][mut_class %in% c("Lethal", "Neutral")]
bet <- ggplot(current, aes(x=time_point, y=meanRatio_no_init, color=nickname)) + 
  geom_errorbar(aes(ymin=meanRatio_no_init-se_no_init, ymax=meanRatio_no_init+se_no_init, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("Beta, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")
#then PF020
current = noriftcsumm[ssap == "PF020"][time_point %in% c(0, 1, 2, 3)][mut_class %in% c("Lethal", "Neutral")]
pf <- ggplot(current, aes(x=time_point, y=meanRatio_no_init, color=nickname, label= N)) + 
  geom_errorbar(aes(ymin=meanRatio_no_init-se_no_init, ymax=meanRatio_no_init+se_no_init, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("PF020, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")

grid.arrange(bet, pf, nrow = 2)

```

### ok trying another thing. let's add back all time points, and do no normalization to neutrals
graphing the "seq freq" variable, with error bars as it's SE

performing this with all time points
```{r plot_norif_seq_freq}
# first, looking at beta
current = noriftcsumm[ssap == "beta"] #[time_point %in% c(0, 1, 2, 3)]
bet <- ggplot(current, aes(x=time_point, y=mean_seq_freq, color=nickname)) + 
  geom_errorbar(aes(ymin=mean_seq_freq-se_freq, ymax=mean_seq_freq+se_freq, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("Beta, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")
#then PF020
current = noriftcsumm[ssap == "PF020"] #[time_point %in% c(0, 1, 2, 3)]
pf <- ggplot(current, aes(x=time_point, y=mean_seq_freq, color=nickname)) + 
  geom_errorbar(aes(ymin=mean_seq_freq-se_freq, ymax=mean_seq_freq+se_freq, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("PF020, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")

grid.arrange(bet, pf, nrow = 2)

```

ratio to neutral median, rather than mean
```{r plot_norif_seq_freq_median}
# first, looking at beta
current = noriftcsumm[ssap == "beta"][time_point %in% c(0, 1, 2, 3)][mut_class %in% c("Lethal", "Neutral", "Drug_resistance")]
bet <- ggplot(current, aes(x=time_point, y=mean_rationeutmed, color=nickname)) + 
  geom_errorbar(aes(ymin=mean_rationeutmed-se_rationeutmed, ymax=mean_rationeutmed+se_rationeutmed, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("Beta, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")
#then PF020
current = noriftcsumm[ssap == "PF020"][time_point %in% c(0, 1, 2, 3)][mut_class %in% c("Lethal", "Neutral", "Drug_resistance")]
pf <- ggplot(current, aes(x=time_point, y=mean_rationeutmed, color=nickname)) + 
  geom_errorbar(aes(ymin=mean_rationeutmed-se_rationeutmed, ymax=mean_rationeutmed+se_rationeutmed, alpha = .3), width=.1) +
  geom_line(aes(alpha = .3)) +
  geom_point(aes(group = nickname, alpha = .3)) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.0001, .001, .01, .1, 1, 10, 100, 1000, 10000)) +
  theme_bw() +
  ggtitle("PF020, no rif") +
  facet_wrap(~mut_class) +
  theme(legend.position="none")

grid.arrange(bet, pf, nrow = 2)

```











# the end

##### session info, for reproducibility
```{r sesh, echo = FALSE, include = FALSE}
sessionInfo()
```

