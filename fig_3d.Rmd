---
title: "Fig_3d_linmodel"
author: "Max Schubert"
date: "6/18/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(data.table)
library(stringr)
library(plyr)
require(ggplot2)
require(data.table)
require(scales)

parent_folder = here::here('fig_3d')

```

```{r get data}
#get RLR trajectory data
lin.mod.path = parent_folder
start.data.file = paste(here::here('fig_3b'), "fig3bdata.RData", sep = "/")
load(start.data.file) #this creates the file megatable ratios

#get clonal growth data
clonal_growth_path = paste(parent_folder, 'summary3C.csv', sep = "/")
clonalgrowth.dt = data.table(fread(clonal_growth_path))
```

```{r summarize, fit}
#prepare summary table with stats per donor per sample, NOT per replicate

megatable5[,
           ratio_median_neutrals := ratio_to_neutrals, #/ ratio_to_neutrals[timepoint==1],
           by=c("nickname", "mut_class","replicate")]

summary <- megatable5[, 
                            list(
                              Count = Count,
                              N= .N,
                              meanRatio= mean(ratio_median_neutrals),
                              sd= sd(ratio_median_neutrals),
                              se= sd(ratio_median_neutrals) / sqrt(.N)),
                            by=c("ratio_expt", "timepoint", "sample_type", "induction", "bc_read", "nickname", "mut_class")]

lm_group <- function(dt_subset, byval) {
  lmod <- lm(log10(ratio_median_neutrals) ~ timepoint, data= dt_subset[is.finite(ratio_median_neutrals)])
  return(list(intercept= lmod$coefficients[1], slope= lmod$coefficients[2], mut_class= dt_subset$mut_class[1]))
}

megatable_slopes <- megatable5[
  (ratio_expt == "A" | ratio_expt == "A_5") & (ratio_median_neutrals > 0) &
    !(timepoint %in% c("0","-1")) & 
    sample_type != 'msDNA' & induction != 'n',
  lm_group(.SD,.BY),
  by='nickname']

```

```{r plot}
summary <- summary[ratio_expt == "A" | ratio_expt == "A_5", ] #looking at rif5
summary <- summary[timepoint != "-1", ]
summary <- summary[timepoint != "0", ]
summary <- summary[sample_type != "msDNA", ]
summary <- summary[induction != "n", ]

ggplot(summary, aes(x=timepoint, y=log10(meanRatio), color=nickname)) + 
  geom_errorbar(aes(ymin=log10(meanRatio-se), ymax=log10(meanRatio+se)), width=.1, show.legend = FALSE) +
  geom_line(show.legend = FALSE) +
  geom_point(aes(group = nickname),show.legend = FALSE) +
  scale_y_continuous(labels = c(.001, .01, .1, 1, 10, 100), breaks=log10(c(.001, .01, .1, 1, 10, 100))) +
  theme_bw() +
  geom_abline(show.legend = FALSE, data=megatable_slopes, aes(intercept=intercept, slope=slope, color=nickname), linetype=2) +
  facet_wrap(~mut_class)
```


```{r look_at_fewer}
simple_summ <- summary[mut_class %in% c('Lethal','Neutral','rpoB Alleles')]
simple_slopes <- megatable_slopes[mut_class %in% c('Lethal','Neutral','rpoB Alleles')]

#write_path = "/Users/Max_Schubert/Dropbox/RLR_e.coli_dropbox/NewNotebook_expts/A_phenotype_in_plates/a27_more_points"
#write.csv(simple_slopes, paste(write_path, 'simple_slopes.csv', sep = "/"))

ggplot(simple_summ, aes(x=timepoint, y=log10(meanRatio), color=nickname)) + 
  geom_errorbar(aes(ymin=log10(meanRatio-se), ymax=log10(meanRatio+se)), width=.1, show.legend = FALSE) +
  geom_line(show.legend = FALSE) +
  geom_point(aes(group = nickname),show.legend = FALSE) +
  scale_y_continuous(labels = c(.001, .01, .1, 1, 10, 100), breaks=log10(c(.001, .01, .1, 1, 10, 100))) +
  theme_bw() +
  geom_abline(show.legend = FALSE, data=simple_slopes, aes(intercept=intercept, slope=slope, color=nickname), linetype=2) +
  facet_wrap(~mut_class)

```

```{r joint_plot}
#this is where i had previously switched to seaborn

simple_slopes[nickname=='rpoB_CACTCGGCCCAG_1595_nan', nickname := 'rpoB_CACTCGGCCCAG_1594_nan']
simple_slopes[nickname=='rpoB_C_1534_T', nickname := 'rpoB_C_1535_T']

indiv_v_rlr <- merge(clonalgrowth.dt, simple_slopes, by.x='hard_desc', by.y='nickname')

ggplot(merge(clonalgrowth.dt, simple_slopes, by.x='hard_desc', by.y='nickname'), 
  aes(x=slope, y=mean)) + 
  geom_point() + 
  stat_smooth(method = "lm", col = "red", se=FALSE) +
  expand_limits(x = 0, y = 0)
```


