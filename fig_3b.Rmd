---
title: "Fig_3B"
author: "Max Schubert"
date: "6/18/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stringr)
library(plyr)
require(ggplot2)
require(data.table)
require(scales)
library(gridExtra)
library(here)
library(ggpubr)
library(here)

parent_folder <- here::here('fig_3b')

```
```{r get data}
#parent_folder <- "/Users/Max_Schubert/Dropbox (Personal)/RLR_e.coli_dropbox/NewNotebook_expts/A_phenotype_in_plates/ms23_testset_primerize"

#this is the file with minimum counts 20
mergebinpath <- paste(parent_folder,"7_18_merged_bins", sep = "/" )
merged_bins.dt <- data.table(fread(mergebinpath))
mergemelt.dt <- melt(merged_bins.dt, id.var=c('read_id', 'total_count', 'bc_read'), value.name='Count', variable.name='Sample')
mergemelt.dt[, unique_id := str_replace_all(Sample, "_cutcount", "")]

```

```{r sample metadata}
#import library annotations, trim some extraneous columns, trim some extraneous rows
liblistpath <- paste(parent_folder,"lib_list.csv", sep = "/" )
liblistdt <- data.table(fread(liblistpath))

liblistdt[, c("Indices",
              "Expected Percent of Pool",
              "File Name",
              "PF Reads",
              "%mergepass",
              "galK_strain",
              "galK_construct"):=NULL]

liblistdt <-liblistdt[ratio_expt != "prev", ]
liblistdt <-liblistdt[ratio_expt != "galk", ]

annotated_megatable <- liblistdt[mergemelt.dt, on = "unique_id", nomatch = 0]

```

```{r sequence metadata}
#read in donor annotations, rename seq to bc_read, merge annotations
allelelistpath <- paste(parent_folder,"allele_annotated_list.csv", sep = "/" )
seq_annot_dt <- data.table(fread(allelelistpath))
seq_annot_dt[, bc_read := prodonor_seq]
#merge these annotations to big table
seq_annotated_megatable <- annotated_megatable[seq_annot_dt, on = "bc_read", nomatch = 0]
```

```{r normalization}
#calculate mean of neutral controls, ratio of each to this
megatable_ratios <- seq_annotated_megatable[, mean_neutrals := mean(Count[mut_class == "Neutral"]), by='unique_id']
megatable_ratios <- megatable_ratios[, ratio_to_neutrals := Count/mean_neutrals, by='bc_read'] #threw away included filter by count statement...

#calculate fraction (useful for rif100, where shit dies)
megatable_ratios <- megatable_ratios[, total_count_uniqid := Count, by='unique_id']
megatable_ratios <- megatable_ratios[, frac.tot := Count/total_count_uniqid, by='bc_read'] #threw away included filter by count statement...

#spoof to change name 
seq_annotated_megatable <- megatable_ratios

####normalize values to expression at t= 1
#first, fix the issue with A, A5, etc by making two tables
a5mega <- seq_annotated_megatable[ratio_expt == 'A'][, ratio_expt := 'A_5'][sample_type != 'msDNA' & replicate != 'D']
a100mega <- seq_annotated_megatable[timepoint %in% c(0, 1) & ratio_expt == 'A'][, ratio_expt := 'A_100'][sample_type == 'plasmid' & replicate != 'D']
restofitA5 <-  seq_annotated_megatable[timepoint %in% c(2, 3) & ratio_expt == 'A_5']
restofitA100 <-  seq_annotated_megatable[timepoint %in% c(2, 3) & ratio_expt == 'A_100']
megatable5 <- rbind(a5mega, restofitA5)
megatable100 <- rbind(a100mega, restofitA100)

#####

megatable5[, read.pct := Count/sum(Count), by=c('timepoint','replicate')]

megatable5[,
           plas.enrichment := ratio_to_neutrals / ratio_to_neutrals[timepoint==-1],
           by=c("nickname", "mut_class")]

# 1. in previous figure, drug resistance goes up
# 2. here, we use smaller growth differences (less drug), we clearly observe effects of smaller changes
# 3. quantitative results make sense
```

```{r fig3b, fig.height=5, fig.width=4, dpi=300}
summary <- megatable5[, 
  list(
    read.pct = mean(read.pct),
    N= .N,
    plas.enrichment= mean(plas.enrichment),
    sd= sd(plas.enrichment),
    se= sd(plas.enrichment) / sqrt(.N)),
  by=c( "timepoint", "sample_type", "induction", "prodonor_seq", "nickname", "mut_class")]

summary <- summary[sample_type != "msDNA" & mut_class %in% c('Lethal','Neutral','Drug_resistance')]

categories_to_plot <- c('Lethal','Neutral','Drug_resistance')
condition_labels <- c(
  'Plasmid\nLibrary',
  'No\nInduction',
  'Induction\n-Rif',
  '20 doublings\n+Rif',
  '40 doublings\n+Rif')

squish_predrug_x <- 0.55
summary[, timepoint := as.numeric(timepoint)]
summary[timepoint == -1, timepoint := 1-squish_predrug_x*2]
summary[timepoint == 0, timepoint := 1-squish_predrug_x]

fig3b <- ggplot(summary,
    aes(x=timepoint, y=plas.enrichment, color=mut_class, group=nickname)) + 
  geom_hline(yintercept=0, color='black', size=1) +
  geom_vline(xintercept=-Inf, color='black', size=1) +
  annotate('rect', ymin=0, ymax=Inf, xmin=-Inf, xmax=1.05, fill='black', alpha=0.1, color=NA) +
  geom_line(show.legend = FALSE) +
  geom_errorbar(aes(ymin=plas.enrichment-se, ymax=plas.enrichment+se),
    width=.1, show.legend = FALSE, color='black', alpha=0.3, width=0.05) +
  geom_point(aes(group = nickname),show.legend = FALSE) +
  scale_y_continuous(trans = log10_trans(), #limit=c(0.0005, 8), 
                     breaks = c(.001, .01, .1, 1, 10, 100, 1000)) +
  scale_x_continuous(labels=condition_labels, breaks=summary[, unique(timepoint)], expand=c(0,0.3)) +
  labs(y='log10 allelic enrichment in population', x='') +
  facet_grid(mut_class~., space='free_y', scales='free_y', switch='both') +
  theme_linedraw() +
  geom_hline(yintercept=1, linetype=2, size=0.5) +
  theme(text = element_text(size=10)) +
  theme(
    strip.background=element_blank(), strip.placement='outside',
    strip.text=element_text(color='black', margin = margin(0,0,0,16, "pt")), 
    panel.spacing=unit(12,'pt'),
    panel.border=element_blank(),
    panel.grid.minor.x=element_blank(),
    axis.line.y=element_blank(),
    axis.line.x=element_blank(),
    legend.position = 'none')

fig3b

ggsave(fig3b, 'fig3b.pdf', width=5, height=4, units='in', dpi=300)

```

