---
title: "Fig_4B"
author: "Max Schubert"
date: "6/18/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
#library(stringr)
library(plyr)
library(gridExtra)
require(ggplot2)
require(data.table)
require(scales)
library(ggpubr)
library(plotly)
#dan's suggestion for plotting:
library(ggrepel)
library(R.utils)

parent_folder = here::here('fig_4B')
source(here::here('constants.R'))

#set global variables for shifting plotting:
ori_pos = 3900000
ter_pos = 1700000
shift_over_value = 1e6
genome_size = 4641652

```

# data for enrichment of alleles, 
```{r get_enriched_SNP_data}
SNP_table = "a3a4.csv"

SNP_path = paste(parent_folder, SNP_table, sep = "/")
SNP_file_dt = data.table(fread(SNP_path))

#ditch columns with na's
#cutting down table to only a few columns
SNP_file_dt = Filter(function(x)!all(is.na(x)), SNP_file_dt) #kills columns with all NA
SNP_file_trimmed_dt = SNP_file_dt[,c( "UID", "POSITION",
                                        "REF", "ALT",
                                        "EXPERIMENT_SAMPLE_LABEL", "DP",
                                        "INFO_EFF_CONTEXT","INFO_EFF_EFFECT",
                                        "INFO_EFF_AA","INFO_EFF_GT",
                                        "INFO_EFF_CLASS", "INFO_EFF_GENE")] #keeps only specified columns

```

#unzip coverage files
```{r unzip coverage files}
gunzip_dp <- function(x){
  dp_name = paste(parent_folder, '/', 's',
               as.character(x), '_depths.gz', sep = "")
  #print(dp_name)
  gunzip(dp_name, remove = FALSE)
}

gunzip_dp(4)
```



```{r before_coverage_data}
#note, could add more samples later
samplenum = 's4'
#depthspath <- "/Users/Max_Schubert/dropbox_hms/active_seq_reads/NovNextseq_again/FC_04398/Unaligned_1234_PF_mm1/Data/bwa_sam_bam_depths/"
path_cov <- paste(parent_folder,"/",samplenum, "_depths", sep = "")
cov <- fread(path_cov)
names(cov) <- c('chr','pos','count')

#slice into windows, label window with middle base of window
window_size <- 1000
cov[, window := cut(pos,
                    breaks=c(seq(0, max(pos), window_size),
                             max(pos)),
                    labels=c(seq(window_size/2, max(pos)-window_size/2, window_size),
                             max(pos)-window_size/2))]

#calculate average depth per window
#wcov <- cov[, window_dp_mean := mean(count), by=window]
wcov_new <- cov[, list(mean_window_count=mean(count)), by=window]


wcov_new[, window := as.numeric(window)*window_size] #change to number
#wcov_new[, position_modulus := (window+shift_over_value)%%(genome_size - shift_over_value)]

#calculate coverage depth as a factor relative to the mean depth
wcov_new[, dp_rel_mean := mean_window_count/mean(mean_window_count)]
wcov_new[, dp_rel_median := mean_window_count/median(mean_window_count)]
# plot coverage at windows
#wcov <- wcov[count > 1000]
SNP_file_trimmed_dt[, dp_rel_mean_log := log10(DP/mean(DP)), by='EXPERIMENT_SAMPLE_LABEL']
SNP_file_trimmed_dt[, dp_rel_mean_log := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']
```

```{r calc_relative_depth_of_snps}
#calculating SNP depth relative to maximum
SNP_file_trimmed_dt[, dp_rel_max := DP/max(DP), by='EXPERIMENT_SAMPLE_LABEL']
#average replicates into new column
SNP_file_trimmed_dt[, mean_dp_rel_max := mean(dp_rel_max), by = UID]

#calculating coverage depth relative to maximum
wcov_new[, dp_rel_max := mean_window_count/max(mean_window_count)]

```

# output figure 4B
# plot "before" and "after_SNPs" together on polar coordinates
```{r plot_all_polar}
all_polar_plot <- ggplot() +

  #data for "before", offset by one to create a circle
  geom_freqpoly(data = wcov_new, stat = "identity",
              aes(y= dp_rel_max + 1 , x=window, color = "Library coverage, before treatment"), color='black', alpha = 0.4) +
  
  #data for "after", offset by one to create a circle
  geom_freqpoly(data = SNP_file_trimmed_dt,
                  aes(x=POSITION, y = mean_dp_rel_max + 1),
                  stat = "identity", size = 1, color = "#E69F00") +
    
    theme(text = element_text(size=18)) +
    theme_minimal() +
    labs( y = "",
          x = "") +
  scale_y_continuous(limits = c(0,2)) +
  scale_x_continuous(breaks = c(0,1E6, 2E6, 3E6, 4E6), #issues with 0
                     labels = c("0", "1", "2", "3", "4")) +
    theme(
      #strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line(), #+#+#,
      legend.position = 'none') +
    coord_polar()

all_polar_plot

ggsave('fig_4B.pdf', plot=all_polar_plot, width=4, height=4, units='in', dpi=300, useDingbats = FALSE)
```

# dbg version of 4b
```{r}

#calculating SNP depth relative to maximum
SNP_file_trimmed_dt[, dp_rel := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']
SNP_file_trimmed_dt[, dp_rel_max_mean := dp_rel/max(dp_rel)]
#average replicates into new column
SNP_file_trimmed_dt[, mean_dp_rel_max := mean(dp_rel_max), by = UID]


colors <- hue_pal()(2)
y_offset = 0.02
genome_x = 4640000
total_x = genome_x + 120000
x_offset = 7000

all_polar_plot <- ggplot() +
  
  # white box containing data
  annotate("rect", ymin=0, ymax=1-y_offset*3, xmin=1, xmax=total_x-1, fill='white') +
  annotate("rect", ymin=1-y_offset*3, ymax=2, xmin=1, xmax=total_x-1, fill=NA, color='grey80') +
  
  #data for "before", offset by one to create a circle
  geom_freqpoly(data = wcov_new, stat = "identity",
              aes(y= dp_rel_max + 1 , x=window, color = "Library coverage, before treatment"), color='black', alpha = 0.4) +

  #data for "after", offset by one to create a circle
  geom_segment(aes(y=1, yend=1, x=1, xend=genome_x), color=colors[1], size=1) +
  geom_segment(aes(y=1+y_offset, yend=1+y_offset, x=1, xend=genome_x), color=colors[2], size=1) +
  geom_linerange(data = SNP_file_trimmed_dt,
                  aes(x=POSITION+x_offset*(EXPERIMENT_SAMPLE_LABEL == '291_303'), ymin=1+y_offset*(EXPERIMENT_SAMPLE_LABEL == '291_303'), ymax = 1+dp_rel_max_mean, color=EXPERIMENT_SAMPLE_LABEL),
                  stat = "identity", size = 1) +
    theme(text = element_text(size=18)) +
    theme_minimal() +
    labs( y = "",
          x = "") +
  scale_x_continuous(limits=c(0,total_x),
                    breaks = c(0.01E6,1E6, 2E6, 3E6, 4E6, genome_x),
                     labels = c("0 Mb / 4.6 Mb", "1 Mb", "2 Mb", "3 Mb", "4 Mb","")) +
  scale_y_continuous(limits=c(0,2+y_offset),
                     breaks = c(1, 2),
                     labels = c('', '')) +
  scale_color_manual(values=colors) +
  
  # grey ticks for y axis inside circle
  geom_segment(data=data.table(y_vals = 1+seq(0,1,0.2), x_vals=total_x), 
    aes(y=y_vals, yend=y_vals, x=x_vals-25000, xend=x_vals-1), color='grey80') +
  
  # label for grey ticks
  geom_text(data=data.table(y_vals = 1+seq(0,1,0.2), x_vals=total_x, lab=c(paste0(seq(0,80,20),'%'),'Max')), 
    aes(y=y_vals, x=x_vals-25000, xend=x_vals-1, label=lab), color='black', size=2, hjust=1.1) +
  
  theme(
    #strip.background=element_blank(), strip.placement='outside',
    strip.text=element_text(color='black'), 
    axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
    panel.border=element_blank(),
    panel.grid.minor.x=element_blank(),
    panel.grid.minor.y=element_blank(),
    panel.grid.major.y=element_blank(),
    axis.line=element_blank(), #+#+#,
    legend.position = 'none') + 
  coord_polar()


all_polar_plot

ggsave('fig_4B_dbg.pdf', plot=all_polar_plot, width=4, height=4, units='in', dpi=300, useDingbats = FALSE)

```


#optional: get rid of unzipped dp files
```{r delete_unzipped_tlen_files}
remove_dp <- function(x){
  dp_name = paste(parent_folder,'/','s', as.character(x),
                  '_depths', sep = "")
  file.remove(dp_name)
}

remove_dp(4)
```




######## cruft !

```{r get data}
#can update when i get the new stuff
test_table = "a3a4.csv"

test_path = paste(parent_folder, test_table, sep = "/")
test_file_dt = data.table(fread(test_path))

#ditch columns with na's
#cutting down table to only a few columns
test_file_dt = Filter(function(x)!all(is.na(x)), test_file_dt) #kills columns with all NA
test_file_trimmed_dt = test_file_dt[,c( "UID", "POSITION",
                                        "REF", "ALT",
                                        "EXPERIMENT_SAMPLE_LABEL", "DP",
                                        "INFO_EFF_CONTEXT","INFO_EFF_EFFECT",
                                        "INFO_EFF_AA","INFO_EFF_GT",
                                        "INFO_EFF_CLASS", "INFO_EFF_GENE")] #keeps only specified columns

```

#background
### this communicates that the whole genome is covered, and that coverage is decently even
```{r before_coverage_data}
#note, could add more samples later
samplenum = 's4'
#depthspath <- "/Users/Max_Schubert/dropbox_hms/active_seq_reads/NovNextseq_again/FC_04398/Unaligned_1234_PF_mm1/Data/bwa_sam_bam_depths/"
path_cov <- paste(parent_folder,"/",samplenum, "_depths", sep = "")
cov <- fread(path_cov)
names(cov) <- c('chr','pos','count')

#slice into windows, label window with middle base of window
window_size <- 1000
cov[, window := cut(pos,
                    breaks=c(seq(0, max(pos), window_size),
                             max(pos)),
                    labels=c(seq(window_size/2, max(pos)-window_size/2, window_size),
                             max(pos)-window_size/2))]

#calculate average depth per window
#wcov <- cov[, window_dp_mean := mean(count), by=window]
wcov_new <- cov[, list(mean_window_count=mean(count)), by=window]


wcov_new[, window := as.numeric(window)*window_size] #change to number
#wcov_new[, position_modulus := (window+shift_over_value)%%(genome_size - shift_over_value)]

#calculate coverage depth as a factor relative to the mean depth
wcov_new[, dp_rel_mean := mean_window_count/mean(mean_window_count)]
wcov_new[, dp_rel_median := mean_window_count/median(mean_window_count)]
# plot coverage at windows
#wcov <- wcov[count > 1000]
```



#these plots are informational, and are not included in the publication
```{r before_coverage_plot_grid}
#plotting absolute, dots
before_cov_plot_dots <- ggplot(wcov_new) + 
  geom_jitter(aes(y=mean_window_count, x=window, alpha = 0.001)) +
  #geom_freqpoly(stat = "identity", aes(y=dp_rel_median, x=window, alpha = 0.001)) +
  theme_bw() +
  labs( y = "Coverage Depth (Unique sequences)") + 
  theme(
    strip.background=element_blank(), #strip.placement='outside',
    strip.text=element_text(color='black'), 
    axis.title.x = element_blank(), 
    panel.border=element_blank(),
    axis.line=element_line(),
    legend.position = 'none') #+
    #annotate("text",
    #         x = (ori_pos+shift_over_value)%%(genome_size - shift_over_value),
    #         y = -10, label = "O") + #annotate ori, adjusted
    #annotate("text",
    #         x = (ter_pos+shift_over_value)%%(genome_size - shift_over_value),
    #         y = -10, label = "X") + 
  #coord_polar()#annotate ter, adjusted
  #facet_wrap(~variable, scales='free') +
  #ggtitle(samplenum)
 #axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")

#plotting absolute
before_cov_plot_absolute <- ggplot(wcov_new) + 
  #geom_jitter(aes(y=mean_count, x=window, alpha = 0.001)) +
  geom_freqpoly(stat = "identity", aes(y=mean_window_count, x=window, alpha = 0.001)) +
  theme_bw() +
  labs( y = "Coverage Depth (Unique sequences)") + 
  theme(
    strip.background=element_blank(), #strip.placement='outside',
    strip.text=element_text(color='black'), 
    axis.title.x = element_blank(), 
    panel.border=element_blank(),
    axis.line=element_line(),
    legend.position = 'none') +
    annotate("text",
             x = (ori_pos),
             y = -10, label = "O") + #annotate ori, adjusted
    annotate("text",
             x = (ter_pos),
             y = -10, label = "X")

#plot the circular version:
before_cov_plot_absolute_polar <- ggplot(wcov_new) + 
  #geom_jitter(aes(y=mean_count, x=window, alpha = 0.001)) +
  geom_freqpoly(stat = "identity", aes(y=log(mean_window_count + 10), x=window, alpha = 0.001)) +
  theme_bw() +
  labs( y = "Coverage Depth (Unique sequences)") + 
  theme(
    strip.background=element_blank(), #strip.placement='outside',
    strip.text=element_text(color='black'), 
    axis.title.x = element_blank(), 
    panel.border=element_blank(),
    axis.line=element_line(),
    legend.position = 'none') + 
  coord_polar()

#annotate, the modulus shifted version  
    #annotate("text",
    #         x = (ori_pos+shift_over_value)%%(genome_size - shift_over_value),
    #         y = -10, label = "O") + #annotate ori, adjusted
    #annotate("text",
    #         x = (ter_pos+shift_over_value)%%(genome_size - shift_over_value),
    #         y = -10, label = "X")#+ 
  #coord_polar()#annotate ter, adjusted
  #facet_wrap(~variable, scales='free') +
  #ggtitle(samplenum)
 #axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")


#before_cov_plot_absolute

#plot both in grid
grid.arrange(
  grobs = list(before_cov_plot_dots, before_cov_plot_absolute, before_cov_plot_absolute_polar),
  #widths = c(2, 1, 1),
  layout_matrix = rbind(c(1, 1, 3, 3),
                        c(2, 2, 3, 3))
)

```


```{r calc_relative_depth_of_snps}
test_file_trimmed_dt[, dp_rel_sum := DP/sum(DP), by='EXPERIMENT_SAMPLE_LABEL']
test_file_trimmed_dt[, dp_rel_mean := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']
test_file_trimmed_dt[, dp_rel_median := DP/median(DP), by='EXPERIMENT_SAMPLE_LABEL']

```

###these are the hits, ori and ter annotated with O and X
```{r plot_relative_depth_of_snps}

# this is still in progress...
after_coverage_plot <- ggplot(test_file_trimmed_dt, aes(x=POSITION, y=dp_rel_sum, color=EXPERIMENT_SAMPLE_LABEL)) + 
    geom_freqpoly(stat = "identity", size = 1, alpha = 0.5) + #position = position_dodge(width = 2),
    geom_jitter(size = 1, alpha = 0.5) +
    theme_bw() +
    theme(text = element_text(size=18)) +
    facet_wrap(EXPERIMENT_SAMPLE_LABEL~., ncol=1) +
    theme_minimal() +
    theme(text = element_text(size=fig_font_size)) +
    labs( y = "Coverage Depth (Percent of SNPs observed)",
          x = "Genomic Position (bp)") +
    scale_y_continuous(breaks = c(0, 10, 20, 30, 40, 50)) +
    theme(
      strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line(),
      legend.position = 'none') +
    annotate("text", x = 3900000, y = -.01, label = "O") + #annotate ori
    annotate("text", x = 1700000, y = -.01, label = "X") #annotate ter

#shifted version with modulus
after_shifted = test_file_trimmed_dt[, position_modulus := (POSITION+shift_over_value)%%(genome_size - shift_over_value)]

after_coverage_plot_shifted <- ggplot(test_file_trimmed_dt, aes(x=position_modulus, y=dp_rel_sum, color=EXPERIMENT_SAMPLE_LABEL)) + 
    #geom_freqpoly(stat = "identity", size = 1, alpha = 0.5) + #position = position_dodge(width = 2),
    geom_col(position = position_dodge(width = 2), size = 1, alpha = 0.5) + #
    geom_jitter(size = 1, alpha = 0.5) +
    theme_bw() +
    theme(text = element_text(size=18)) +
    facet_wrap(EXPERIMENT_SAMPLE_LABEL~., ncol=1) +
    theme_minimal() +
    theme(text = element_text(size=fig_font_size)) +
    labs( y = "Coverage Depth (Percent of SNPs observed)",
          x = "Genomic Position (bp)") +
    scale_y_continuous(breaks = c(0, 10, 20, 30, 40, 50)) +
    theme(
      strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line(),
      legend.position = 'none') +
    annotate("text", x = (3900000+shift_over_value)%%(genome_size - shift_over_value), y = -.01, label = "O") + #annotate ori
    annotate("text", x = (1700000+shift_over_value)%%(genome_size - shift_over_value), y = -.01, label = "X") #annotate ter

#plot both in grid
grid.arrange(
  grobs = list(after_coverage_plot, after_coverage_plot_shifted),
  #widths = c(2, 1, 1),
  layout_matrix = rbind(c(1, 1),
                        c(2, 2))
)


#after_coverage_plot
```

#test version with relative position
```{r calc_relative_depth_of_snps}
test_file_trimmed_dt[, dp_rel_sum := DP/sum(DP), by='EXPERIMENT_SAMPLE_LABEL']
test_file_trimmed_dt[, dp_rel_mean := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']
test_file_trimmed_dt[, dp_rel_median := DP/median(DP), by='EXPERIMENT_SAMPLE_LABEL']

#test_file_trimmed_dt[, rel_enrichment_dp := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']
#test_file_trimmed_dt[, dp_rel_mean_log := log(dp_rel_mean)]
#add a differing "bump" so that logged values are in different positions on the x
#test_file_trimmed_dt_with_offset = test_file_trimmed_dt[ EXPERIMENT_SAMPLE_LABEL == "291_303", offset := 29]
#test_file_trimmed_dt_with_offset[ EXPERIMENT_SAMPLE_LABEL == "292_304", offset := 30]

#test_file_trimmed_dt_with_offset[, rel_enrichment_dp_log_offset := dp_rel_mean_log + offset]
#test_file_trimmed_dt_with_offset[, dp_rel_mean_offset := dp_rel_mean + offset]

```


#idea one:
### plot in normal XY, with coverage before on same plot
```{r plot_rel_depths}

# this is still in progress...
after_coverage_plot <- ggplot() +
    #data for "after"
    geom_bar(data = test_file_trimmed_dt,
                  aes(x=POSITION, y=dp_rel_median, color=EXPERIMENT_SAMPLE_LABEL),
                  stat = "identity", size = 1, alpha = 1) +
    #geom_point(size = 2) +
  
  #data for "before"
    #geom_freqpoly(data = wcov_new, stat = "identity",
    #          aes(y=dp_rel_mean, x=window, color = "gray30")) +
    geom_freqpoly(data = wcov_new, stat = "identity",
              aes(y=dp_rel_median, x=window, color = "gray30")) +
    
    theme(text = element_text(size=18)) +
    theme_minimal() +
    labs( y = "Coverage Depth (relative)",
          x = "Genomic Position (Mbp)") +
    scale_y_continuous(#breaks = c(20, 30, 40, 50, 60, 70, 80), 
                       #labels = c(0, 10, 20, 30, 40, 50, 60), 
                       trans = log10_trans()) + #, #imposing offset of 20, because 20 was added to data to make the chart hollow
                       #limits = c(0, 77)) +
    scale_x_continuous(breaks = c(1E6, 2E6, 3E6, 4E6, genome_size), #having issues marking zero
                       labels = c("1", "2", "3", "4", "0")) +
    theme(
      strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line()) #+#,
      #legend.position = 'none') +
    #coord_polar()

after_coverage_plot
```

#idea two:
### plot in polar coordinates
```{r plot_all_polar}
# this is still in progress...

#average replicates for the polar plot

test_file_trimmed_dt[, mean_dp_rel_sum := mean(dp_rel_sum), by = UID]
test_file_trimmed_dt[, mean_dp_rel_median := mean(dp_rel_median), by = UID]
test_file_trimmed_dt[, mean_dp := mean(DP), by = UID]

all_polar_plot <- ggplot() +
    #geom_point(size = 2) +
  #data for "before"
    #geom_freqpoly(data = wcov_new, stat = "identity",
    #          aes(y=dp_rel_mean, x=window, color = "gray30")) +
    
  #data for "before"
  geom_freqpoly(data = wcov_new, stat = "identity",
              aes(y=mean_window_count + 1 , x=window, color = "Library coverage, before treatment"), color='black', alpha = 0.4) +
  
  #data for "after"
  geom_freqpoly(data = test_file_trimmed_dt,
                  aes(x=POSITION, y=mean_dp + 1),
                  stat = "identity", size = 1, color = "#E69F00") +
#  #data for "after"
#  geom_col(data = test_file_trimmed_dt_with_offset[EXPERIMENT_SAMPLE_LABEL == "292_304"],
#                  aes(x=POSITION, y=dp_rel_sum + 1,
#                      color=EXPERIMENT_SAMPLE_LABEL),
#                  stat = "identity", size = 1, alpha = 0.5, color = "#56B4E9", position_nudge(y = -0.05)) +
  
    
    theme(text = element_text(size=18)) +
    theme_minimal() +
    labs( y = "Coverage Depth (relative)",
          x = "Genomic Position (Mbp)") +
  scale_y_continuous(trans = log10_trans()) +
    #scale_y_continuous(breaks = c(1, 1.2, 1.4, 1.6, 1.8, 2), 
    #                   labels = c(0, 0.2, 0.4, 0.6, 0.8, 1)) + #, 
                       #trans = log2_trans()) + #, 
                       #limits = c(0, 2)) + #for relative values
    scale_x_continuous(breaks = c(1E6, 2E6, 3E6, 4E6, 1), #having issues marking zero
                       labels = c("1", "2", "3", "4", "0")) +
    theme(
      #strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      #panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line()) #+#+#,
      #legend.position = 'none') +
    #coord_polar()

all_polar_plot

#ggsave('polar_plot_pre.pdf', plot=all_polar_plot, width=6, height=6, units='in', dpi=300, useDingbats = FALSE)
```



```{r plot_both}


```



```{r zoom_plot}
#for zoom in on folA locus
zoomed_dt = test_file_trimmed_dt[POSITION < 60000]
zoomed_dt = subset(zoomed_dt, EXPERIMENT_SAMPLE_LABEL = "291_303")


ggplot(zoomed_dt, aes(x=POSITION, y=DP)) + 
  geom_col(position = position_dodge(width = 0.9), fill = "#FF6666", size =2 ) +
  theme_bw() +
  scale_y_continuous(trans = log10_trans()) +
  theme(text = element_text(size=24)) +
  theme_bw() +
  labs(
    x = "Mutations, shown at their position on the chromosome",
    y = "Depth of coverage",
    title = "Loci conferring TMP resistance in sheared gDNA RLR")

#optional, to inspect plot
#ggplotly()


#version that is less zoomed
zoomed_dt = test_file_trimmed_dt[POSITION < 1000000]
zoomed_dt = subset(zoomed_dt, EXPERIMENT_SAMPLE_LABEL = "291_303")


ggplot(zoomed_dt, aes(x=POSITION, y=DP)) + 
  geom_col(position = position_dodge(width = 0.9), fill = "#FF6666", size = 100) +
  theme_bw() +
  scale_y_continuous(trans = log10_trans()) +
  theme(text = element_text(size=24)) +
  theme_bw() +
  labs(
    x = "Mutations, shown at their position on the chromosome",
    y = "Depth of coverage",
    title = "Loci conferring TMP resistance in sheared gDNA RLR")

```


#test version with shift by modulus of X
```{r plot_relative_depth_of_snps}
test_file_trimmed_dt[, rel_dp := DP/sum(DP), by='EXPERIMENT_SAMPLE_LABEL']
test_file_trimmed_dt[, rel_enrichment_dp := DP/mean(DP), by='EXPERIMENT_SAMPLE_LABEL']

#shift plot, so that rep origin appears near plot origin
test_file_trimmed_dt[, position_modulus := (POSITION+shift_over_value)%%(genome_size - shift_over_value)]

# this is still in progress...
after_coverage_plot <- ggplot(test_file_trimmed_dt, aes(x=position_modulus, y=rel__enrichment_dp, color=EXPERIMENT_SAMPLE_LABEL)) + 
    geom_freqpoly(stat = "identity", size = 1, alpha = 1) + #position = position_dodge(width = 2),
    geom_jitter(size = 1) +
    theme_bw() +
    theme(text = element_text(size=18)) +
    facet_wrap(EXPERIMENT_SAMPLE_LABEL~., ncol=1) +
    theme_minimal() +
    theme(text = element_text(size=fig_font_size)) +
    labs( y = "Coverage Depth (Percent of SNPs observed)",
          x = "Genomic Position (bp) MODULUS") +
    theme(
      strip.background=element_blank(), strip.placement='outside',
      strip.text=element_text(color='black'), 
      axis.title.x=element_text(margin = margin(1.2*fig_font_size,0,0,0, "pt")), 
      panel.border=element_blank(),
      panel.grid.minor.x=element_blank(),
      panel.grid.minor.y=element_blank(),
      axis.line=element_line(),
      legend.position = 'none') +
    annotate("text",
             x = (ori_pos+shift_over_value)%%(genome_size - shift_over_value),
             y = -.01, label = "O") + #annotate ori, adjusted
    annotate("text",
             x = (ter_pos+shift_over_value)%%(genome_size - shift_over_value),
             y = -.01, label = "X") #annotate ter, adjusted


after_coverage_plot
```
